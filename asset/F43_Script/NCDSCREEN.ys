{"NAME":"NCDSCREEN","LASTUPDATE":"20190719104220","SQLSCRIPT":" SELECT  '[#HOSCODE]' HOSPCODE, RIGHT(CONCAT('000000',p1.person_id),6) PID, q.seq_id SEQ, CAST(p2.screen_date AS UNSIGNED) DATE_SERV, IF(p2.in_hospital IS NULL OR p2.in_hospital='N',2,1) SERVPLACE, IF(p4.present_non_smoking='Y',1,IF(p4.present_smoking='N',1,IF(p4.present_smoking='Y',4,4))) SMOKE, IF(p4.present_drinking_alcohol='N',1,IF(p4.present_drinking_alcohol='Y',4,9)) ALCOHOL, IF(p4.family_relate_dm_disease='N' OR p4.family_parent_dm_disease='N',2,IF(p4.family_relate_dm_disease='Y' OR p4.family_parent_dm_disease='Y',1,9)) DMFAMILY, IF(p4.family_relate_ht_disease='N' OR p4.family_parent_ht_disease='N',2,IF(p4.family_relate_ht_disease='Y' OR p4.family_parent_ht_disease='Y',1,9)) HTFAMILY, FORMAT(p2.body_weight,1) WEIGHT, FORMAT(p2.body_height,0) HEIGHT, ROUND(p2.waist) WAIST_CM, IFNULL(p5.bps,0) SBP_1, IFNULL(p5.bpd,0) DBP_1, IFNULL(p6.bps,0) SBP_2, IFNULL(p6.bpd,0) DBP_2, IF(p2.ppg IS NOT NULL,FORMAT(p2.ppg,2),IF(p2.last_fgc IS NOT NULL,FORMAT(p2.last_fgc,2),IF(p2.last_fgc_no_food_limit IS NOT NULL,FORMAT(p2.last_fgc_no_food_limit,2),FORMAT(p2.last_fpg,2)))) BSLEVEL, IF(p2.ppg IS NOT NULL,2,IF(p2.last_fgc IS NOT NULL,3,IF(p2.last_fgc_no_food_limit IS NOT NULL,4,IF(p2.last_fpg IS NOT NULL,1,'')))) BSTEST, IFNULL(p2.screen_hospcode,'[#HOSCODE]') SCREENPLACE, p2.doctor_code PROVIDER, CAST(p1.last_screen_datetime AS UNSIGNED) D_UPDATE, p3.cid CID  FROM person_dmht_screen_summary p1   LEFT JOIN person_dmht_risk_screen_head p2 ON p2.person_dmht_screen_summary_id = p1.person_dmht_screen_summary_id   LEFT JOIN person p3 ON p3.person_id = p1.person_id   LEFT JOIN person_dmht_nhso_screen p4 ON p4.person_dmht_screen_summary_id = p1.person_dmht_screen_summary_id   LEFT JOIN person_ht_risk_bp_screen p5 ON p5.person_dmht_risk_screen_head_id = p2.person_dmht_risk_screen_head_id AND p5.screen_no = 1   LEFT JOIN person px ON px.person_id = p1.person_id   LEFT JOIN person_ht_risk_bp_screen p6 ON p6.person_dmht_risk_screen_head_id = p2.person_dmht_risk_screen_head_id AND p6.screen_no = 2   left join ovst o on o.hn=p3.patient_hn and o.vstdate=p2.screen_date  left join ovst_seq q on q.vn=o.vn  WHERE p1.status_active='Y'  AND p1.person_dmht_screen_summary_id IN (SELECT DISTINCT pdm.person_dmht_screen_summary_id FROM person_dmht_risk_screen_head pdm )  AND p2.screen_date BETWEEN '[#DATE_START]' and '[#DATE_END]' UNION select  '[#HOSCODE]' HOSPCODE, RIGHT(CONCAT('000000',ps.person_id),6) PID, q.seq_id SEQ, CAST(vn.vstdate AS UNSIGNED) DATE_SERV, IF(ov.ovstist='09',2,1) SERVPLACE, IF(op.smoking_type_id='1',1,IF(op.smoking_type_id='2',3,IF(op.smoking_type_id='3',1,IF(op.smoking_type_id='4',9,9)))) SMOKE, IF(op.drinking_type_id='1',1,IF(op.drinking_type_id='2',3,IF(op.drinking_type_id='3',2,9))) ALCOHOL, '9' DMFAMILY, '9' HTFAMILY, FORMAT(IFNULL(op.bw,0),1) WEIGHT, FORMAT(IFNULL(op.height,0),0) HEIGHT, IF(op.waist='' OR op.waist IS NULL,0,FORMAT(op.waist,0)) WAIST_CM, IF(op.bps='' OR op.bps IS NULL,0,FORMAT(op.bps,0)) SBP_1, IF(op.bpd='' OR op.bpd IS NULL,0,FORMAT(op.bpd,0)) DBP_1, IF(ob.bps='' OR ob.bps IS NULL,0,FORMAT(ob.bps,0)) SBP_2, IF(ob.bpd='' OR ob.bpd IS NULL,0,FORMAT(ob.bpd,0)) DBP_2, IF(op.fbs IS NOT NULL,FORMAT(op.fbs,2),IF(of.dtx1 IS NOT NULL,FORMAT(of.dtx1,2),IF(of.dtx2 IS NOT NULL,FORMAT(of.dtx2,2),0.00))) BSLEVEL, IF(op.fbs<>0,1,IF(of.dtx1<>0,3,IF(of.dtx1<>0,4,9))) BSTEST, '[#HOSCODE]' SCREENPLACE, vn.dx_doctor PROVIDER, DATE_FORMAT(q.update_datetime,'%Y%m%d%H%i%s') D_UPDATE, ps.cid CID from opdscreen op left join vn_stat vn on vn.vn=op.vn left join opdscreen_bp ob on ob.vn=op.vn and (ob.bps<>op.bps or ob.bpd<>op.bpd) left join opdscreen_fbs of on of.vn=op.vn left join ovst ov on ov.vn=vn.vn left join ovst_seq q ON q.vn = vn.vn  left join screen_doctor s on s.vn=op.vn left join opduser ou on ou.loginname=s.staff left join doctor d on d.code=ou.doctorcode left join patient pt on pt.hn=op.hn left join person ps on ps.patient_hn=pt.hn where op.vstdate BETWEEN '[#DATE_START]' and '[#DATE_END]' and vn.age_y>=35 and op.bw>0 and op.height>0 and op.waist>0 and op.bps>0 and op.bpd>0 and (op.fbs>0 or of.dtx1>0 or of.dtx2) and ps.person_id not in (select person_id from person_dmht_screen_summary where bdg_year=('[#YEAR]'+543)and last_screen_datetime is not null)  and pt.hn not in (select a3.hn from clinicmember a3 left join clinic a4 on a4.clinic=a3.clinic where a4.icd10 between 'I10' and 'I159') UNION select  '[#HOSCODE]' HOSPCODE, RIGHT(CONCAT('000000',ps.person_id),6) PID, q.seq_id SEQ, CAST(vn.vstdate AS UNSIGNED) DATE_SERV, IF(ov.ovstist='09',2,1) SERVPLACE, IF(op.smoking_type_id='1',1,IF(op.smoking_type_id='2',3,IF(op.smoking_type_id='3',1,IF(op.smoking_type_id='4',9,9)))) SMOKE, IF(op.drinking_type_id='1',1,IF(op.drinking_type_id='2',3,IF(op.drinking_type_id='3',2,9))) ALCOHOL, '9' DMFAMILY, '9' HTFAMILY, FORMAT(IFNULL(op.bw,0),1) WEIGHT, FORMAT(IFNULL(op.height,0),0) HEIGHT, IF(op.waist='' OR op.waist IS NULL,0,FORMAT(op.waist,0)) WAIST_CM, IF(op.bps='' OR op.bps IS NULL,0,FORMAT(op.bps,0)) SBP_1, IF(op.bpd='' OR op.bpd IS NULL,0,FORMAT(op.bpd,0)) DBP_1, IF(ob.bps='' OR ob.bps IS NULL,0,FORMAT(ob.bps,0)) SBP_2, IF(ob.bpd='' OR ob.bpd IS NULL,0,FORMAT(ob.bpd,0)) DBP_2, IF(op.fbs IS NOT NULL,FORMAT(op.fbs,2),IF(of.dtx1 IS NOT NULL,FORMAT(of.dtx1,2),IF(of.dtx2 IS NOT NULL,FORMAT(of.dtx2,2),0.00))) BSLEVEL, IF(op.fbs<>0,1,IF(of.dtx1<>0,3,IF(of.dtx1<>0,4,9))) BSTEST, '[#HOSCODE]' SCREENPLACE, vn.dx_doctor PROVIDER, DATE_FORMAT(q.update_datetime,'%Y%m%d%H%i%s') D_UPDATE, ps.cid CID from opdscreen op left join vn_stat vn on vn.vn=op.vn left join opdscreen_bp ob on ob.vn=op.vn and (ob.bps<>op.bps or ob.bpd<>op.bpd) left join opdscreen_fbs of on of.vn=op.vn left join ovst ov on ov.vn=vn.vn left join ovst_seq q ON q.vn = vn.vn  left join screen_doctor s on s.vn=op.vn left join opduser ou on ou.loginname=s.staff left join doctor d on d.code=ou.doctorcode left join patient pt on pt.hn=op.hn left join person ps on ps.patient_hn=pt.hn where op.vstdate BETWEEN '[#DATE_START]' and '[#DATE_END]' and vn.age_y>=35 and op.bw>0 and op.height>0 and op.waist>0 and (op.fbs>0 or of.dtx1>0 or of.dtx2) and ps.person_id not in (select person_id from person_dmht_screen_summary where bdg_year=('[#YEAR]'+543) and last_screen_datetime is not null)  and pt.hn not in (select a1.hn from clinicmember a1 left join clinic a2 on a2.clinic=a1.clinic where a2.icd10 between 'E10' and 'E149') ORDER BY SEQ"}